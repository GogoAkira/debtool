#!/bin/bash
#
# bash completion file for debtool


# ensure bash-completion is installed
if ! dpkg -s bash-completion 2>/dev/null | grep -Fq "Status: install ok installed"; then
    return 0
fi

# ensure debtool is on the PATH
_have debtool && {

_lsdebs(){
    # include directories (except hidden ones)
    compgen -d -X '?(*/).*' -- "$1"

    # include files ending with .deb or .DEB
    compgen -f -X '!*.@(deb|DEB)' -- "$1"
}

_debtool(){
    local cur i special

    COMPREPLY=()
    cur=${COMP_WORDS[COMP_CWORD]}

    for (( i=0; i < ${#COMP_WORDS[@]}-1; i++ )); do
        if [[ ${COMP_WORDS[i]} == @(-b|-br|--build|-c|--combo|-d|--download|--fast|-i|--interactive|-r|-rb|--reinst|--repack|-s|--show|-u|--unpack|-z) ]]; then
            special=${COMP_WORDS[i]}
        fi
    done

    if [[ -n $special ]]; then
        case $special in
            -b|-br|--build|--fast|-rb|-z)

                # configure pathname completion
                compopt -o filenames &>/dev/null

                # include directories (except hidden ones)
                readarray -t COMPREPLY < \
                    <( compgen -d -X '?(*/).*' -- "$cur" )

                return 0
                ;;

            -c|--combo|-d|--download|-i|--interactive|-s|--show)

                # include packages in apt-cache
                readarray -t COMPREPLY < \
                    <( _xfunc dpkg apt-cache --no-generate pkgnames "$cur" 2>/dev/null )

                return 0
                ;;

            -r|--reinst)

                # configure pathname completion
                compopt -o filenames &>/dev/null

                # include directories and debian archives
                readarray -t COMPREPLY < <( _lsdebs "$cur" )

                return 0
                ;;

            --repack)

                # include installed packages
                readarray -t COMPREPLY < \
                    <( _xfunc dpkg _comp_dpkg_installed_packages "$cur" 2>/dev/null )

                return 0
                ;;

            -u|--unpack)

                # configure pathname completion
                compopt -o filenames &>/dev/null

                # include directories, debian archives, and installed packages
                readarray -t COMPREPLY < \
                    <( _lsdebs "$cur"
                       _xfunc dpkg _comp_dpkg_installed_packages "$cur" 2>/dev/null )

                return 0
                ;;
        esac
    fi

    if [[ $cur = -* ]]; then
        # add completion for all of debtool's command line options
        readarray -t COMPREPLY < \
            <( compgen -W '-a --auto -b --build -c --combo -d --download
                           -f --fast --format -h --help -i --interactive
                           -m --md5sums -q --quiet -r --reinst --repack
                           -s --show -u --unpack -z' -- "$cur" )
    fi

    return 0
}

complete -F _debtool debtool

}
